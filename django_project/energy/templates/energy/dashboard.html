{% extends "energy/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- ========== MAIN CONTENT ========== -->
<div class="min-h-screen bg-gray-50 p-8">

    <!-- ===== HERO: TOTAL A PAGAR ===== -->
    <section class="mb-8">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">TOTAL A PAGAR</span>
                    <!-- Dynamic percentage change - for now showing 0% as we don't have historical data -->
                    <span class="inline-flex items-center gap-1 text-xs font-semibold text-gray-600 bg-gray-50 border border-gray-200 rounded-full px-2.5 py-0.5">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3">
                            <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .354.146l3 3a.5.5 0 0 1-.708.708L8.5 4.207V12.5a.5.5 0 0 1-1 0V4.207L5.354 4.854a.5.5 0 0 1-.708-.708l3-3A.5.5 0 0 1 8 1Z" clip-rule="evenodd" />
                        </svg>
                        Sin cambio
                    </span>
                </div>
                <p class="text-6xl font-extrabold text-gray-900 tracking-tight">${{bill.total_recibo_mxn}}</p>
                <!-- Due date badge -->
                <div class="mt-3">
                    <span class="inline-flex items-center gap-1.5 text-sm font-semibold text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M6.75 2.25A.75.75 0 0 1 7.5 3v1.5h9V3A.75.75 0 0 1 18 3v1.5h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9a1.5 1.5 0 0 0-1.5-1.5H5.25a1.5 1.5 0 0 0-1.5 1.5v7.5a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5v-7.5Z" clip-rule="evenodd" />
                        </svg>
                        Vence: {{bill.periodo_fin|date:"d M Y"}}
                    </span>
                </div>
            </div>

            <!-- CTA Button -->
            <a href="{% url 'energy:survey' bill_id=bill.id %}"
               class="inline-flex items-center gap-2 px-6 py-4 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 group">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5Z" clip-rule="evenodd" />
                </svg>
                <span class="text-lg">Descubre cómo ahorrar</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 group-hover:translate-x-1 transition-transform">
                    <path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z" clip-rule="evenodd" />
                </svg>
            </a>
        </div>
    </section>

    <!-- ===== 4 STAT CARDS ROW ===== -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">

        <!-- Card 1: CONSUMO -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-3">
                <!-- House icon -->
                <div class="w-11 h-11 bg-blue-50 rounded-xl flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                        <!-- small lightning inside -->
                    </svg>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">CONSUMO</p>
                    <p class="text-2xl font-bold text-gray-900">{{bill.consumo_kwh}} <span class="text-sm font-normal text-gray-500">kWh</span></p>
                </div>
            </div>
        </div>

        <!-- Card 2: PRECIO BÁSICO -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-3">
                <!-- Green circle with $ icon -->
                <div class="w-11 h-11 bg-green-50 rounded-xl flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <circle cx="10" cy="10" r="6"/>
                        <text x="7" y="13" font-size="7" fill="#22c55e" stroke="none" font-weight="bold">$</text>
                    </svg>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">PRECIO BÁSICO</p>
                    <p class="text-2xl font-bold text-gray-900">${{bill.precio_basico}} <span class="text-sm font-normal text-gray-500">/kWh</span></p>
                </div>
            </div>
        </div>

        <!-- Card 3: PRECIO INTERMEDIO -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-3">
                <!-- Yellow circle with $ icon -->
                <div class="w-11 h-11 bg-yellow-50 rounded-xl flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <circle cx="10" cy="10" r="6"/>
                        <text x="7" y="13" font-size="7" fill="#eab308" stroke="none" font-weight="bold">$</text>
                    </svg>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">PRECIO INTERMEDIO</p>
                    <p class="text-2xl font-bold text-gray-900">${{bill.precio_intermedio}} <span class="text-sm font-normal text-gray-500">/kWh</span></p>
                </div>
            </div>
        </div>

        <!-- Card 4: PRECIO EXCEDENTE -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5">
            <div class="flex items-center gap-3">
                <!-- Red circle with $ icon -->
                <div class="w-11 h-11 bg-red-50 rounded-xl flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <circle cx="10" cy="10" r="6"/>
                        <text x="7" y="13" font-size="7" fill="#ef4444" stroke="none" font-weight="bold">$</text>
                    </svg>
                </div>
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">PRECIO EXCEDENTE</p>
                    <p class="text-2xl font-bold text-gray-900">${{bill.precio_excedente}} <span class="text-sm font-normal text-gray-500">/kWh</span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== BOTTOM SECTION: SUMMARY TABS (left) + INVOICE BREAKDOWN (right) ===== -->
    <section class="flex flex-col lg:flex-row gap-5">

        <!-- LEFT: Summary Card -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm flex-1 overflow-hidden">

            <!-- Content -->
            <div class="p-6">

                <!-- Header: Rangos de Consumo -->
                <div class="flex items-center mb-5">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1e293b" class="w-5 h-5">
                            <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
                        </svg>
                        <h3 class="text-base font-bold text-gray-900">Rangos de Consumo</h3>
                    </div>
                </div>

                <!-- ===== BÁSICO ===== -->
                <div class="mb-5">
                    <div class="flex items-center justify-between mb-1.5">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>
                            <span class="text-sm font-bold text-gray-800">Básico</span>
                            <span class="text-xs text-gray-400">(0 - 150 kWh)</span>
                        </div>
                        <span class="text-sm font-bold text-green-600">{{bill.consumo_basico}} kWh</span>
                    </div>
                    <!-- Dynamic progress bar -->
                    <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-green-500 rounded-full" style="width: {{ basico_pct }}%;"></div>
                    </div>
                    <!-- Note -->
                    <div class="flex items-center gap-1.5 mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#22c55e" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.707-9.293a1 1 0 0 0-1.414-1.414L9 10.586 7.707 9.293a1 1 0 0 0-1.414 1.414l2 2a1 1 0 0 0 1.414 0l4-4Z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-xs text-gray-500">Tarifa más baja aplicada.</span>
                    </div>
                </div>

                <!-- ===== INTERMEDIO ===== -->
                <div class="mb-5">
                    <div class="flex items-center justify-between mb-1.5">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-yellow-500 inline-block"></span>
                            <span class="text-sm font-bold text-gray-800">Intermedio</span>
                            <span class="text-xs text-gray-400">(151 - 280 kWh)</span>
                        </div>
                        <span class="text-sm font-bold text-yellow-600">{{bill.consumo_intermedio}} kWh</span>
                    </div>
                    <!-- Yellow progress bar -->
                    <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-yellow-500 rounded-full" style="width: {{ intermedio_pct }}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Tarifa moderada.</p>
                </div>

                <!-- ===== EXCEDENTE ===== -->
                <div class="mb-5">
                    <div class="flex items-center justify-between mb-1.5">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>
                            <span class="text-sm font-bold text-gray-800">Excedente</span>
                            <span class="text-xs text-gray-400">(> 280 kWh)</span>
                        </div>
                        <span class="text-sm font-bold text-red-600">{{bill.consumo_excedente}} kWh</span>
                    </div>
                    <!-- Red progress bar -->
                    <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-red-500 rounded-full" style="width: {{ excedente_pct }}%;"></div>
                    </div>
                </div>

                <!-- ===== WARNING ALERT ===== -->
                {% if bill.consumo_excedente > 0 or bill.tarifa == 'DAC' %}
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mt-2">
                    <div class="flex items-start gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#ef4444" class="w-5 h-5 flex-shrink-0 mt-0.5">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-1-8a1 1 0 0 0-1 1v3a1 1 0 0 0 2 0V6a1 1 0 0 0-1-1Z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <p class="text-sm font-bold text-red-600">
                                {% if bill.tarifa == 'DAC' %}
                                    Estás en tarifa DAC (Alto Consumo)
                                {% else %}
                                    Tienes consumo excedente
                                {% endif %}
                            </p>
                            <p class="text-xs text-red-500 mt-0.5">
                                {% if bill.tarifa == 'DAC' %}
                                    Se está cobrando tarifa especial por alto consumo.
                                {% else %}
                                    Se está cobrando +$3.50/kWh extra por los {{ bill.consumo_excedente }} kWh excedentes.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- RIGHT: Desglose de Factura -->
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm w-full lg:w-80 flex-shrink-0">
            <div class="p-6">

                <!-- Title -->
                <div class="flex items-center gap-2 mb-5">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1e293b" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M5.625 1.5H9a3 3 0 0 1 3 3v1.5h6.75a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-13.5a3 3 0 0 1-3-3v-13.5a3 3 0 0 1 3-3Zm3.75 5.25a.75.75 0 0 0-.75-.75H5.625a.75.75 0 0 0-.75.75v.75c0 .414.336.75.75.75h2.625a.75.75 0 0 0 .75-.75v-.75Z" clip-rule="evenodd" />
                        <path d="M12 5.25a.75.75 0 0 1 .75-.75H15a.75.75 0 0 1 .75.75v.03a.75.75 0 0 1-.75.75h-2.25A.75.75 0 0 1 12 6.03v-.78Z" />
                    </svg>
                    <h3 class="text-base font-bold text-gray-900">Desglose de Factura</h3>
                </div>

                <!-- Line items -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Energía ({{bill.consumo_kwh}} kWh)</span>
                        <span class="text-sm font-bold text-gray-900">${{bill.subtotal_energia}}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">IVA (16%)</span>
                        <span class="text-sm font-bold text-gray-900">${{bill.iva}}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <span class="text-sm text-gray-600">DAP (Alumbrado)</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#6b7280" class="w-3.5 h-3.5">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0ZM7 8.268a.75.75 0 0 0-.75.75v.03c0 .414.336.75.75.75h.008a.75.75 0 0 0 .75-.75V9.018a.75.75 0 0 0-.75-.75H7Zm5.625 0a.75.75 0 0 0-.75.75v.03c0 .414.336.75.75.75h.008a.75.75 0 0 0 .75-.75V9.018a.75.75 0 0 0-.75-.75h-.008Zm-.391 2.143a.75.75 0 0 0-1.061 1.061c.176.177.28.415.28.668s-.104.491-.28.668c-.293.293-.293.768 0 1.061a.75.75 0 0 0 1.06 0c.587-.586.94-1.38.94-2.25s-.353-1.664-.94-2.25Z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <span class="text-sm font-bold text-gray-900">${{bill.dap}}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="#22c55e" class="w-3.5 h-3.5">
                                <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1Zm3.5 4.5a.5.5 0 0 1 0 .707l-4 4a.5.5 0 0 1-.707 0l-2-2a.5.5 0 0 1 .707-.707L7 8.793l3.646-3.646a.5.5 0 0 1 .707 0Z" />
                            </svg>
                            <span class="text-sm font-semibold text-green-600">Subsidio</span>
                        </div>
                        <span class="text-sm font-bold text-green-600">-${{bill.subsidio}}</span>
                    </div>
                </div>

                <!-- Divider -->
                <hr class="my-4 border-gray-100">

                <!-- Total -->
                <div class="flex items-center justify-between">
                    <span class="text-base font-bold text-gray-900">Total</span>
                    <span class="text-xl font-extrabold text-blue-600">${{bill.total_recibo_mxn}}</span>
                </div>
            </div>
        </div>
    </section>
</div>

{% endblock %}